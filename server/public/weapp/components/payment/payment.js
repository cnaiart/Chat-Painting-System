"use strict";const e=require("../../common/vendor.js"),r=require("../../utils/pay/index.js"),u=require("../../api/pay.js"),t=require("../../hooks/useLockFn.js"),o=require("../../enums/appEnums.js"),s=require("../../stores/user.js"),a=require("../../utils/client.js");if(require("../../utils/pay/alipay.js"),require("../../utils/pay/balance.js"),require("../../utils/pay/pay.js"),require("../../utils/pay/wechat.js"),require("../../utils/pay/e_wechat.js"),require("../../utils/pay/e_alipay.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../router/index.js"),require("../../utils/cache.js"),require("../../enums/constantEnums.js"),require("../../config/index.js"),require("../../api/user.js"),require("../../mixins/share.js"),require("../../api/task.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../stores/app.js"),require("../../api/app.js"),require("../../utils/auth.js"),!Array){(e.resolveComponent("u-empty")+e.resolveComponent("u-icon")+e.resolveComponent("u-radio")+e.resolveComponent("u-radio-group")+e.resolveComponent("price")+e.resolveComponent("u-button")+e.resolveComponent("page-status")+e.resolveComponent("u-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-radio/u-radio.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-radio-group/u-radio-group.js")+(()=>"../price/price.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../page-status/page-status.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+i)();const i=()=>"./check.js",n=e.defineComponent({__name:"payment",props:{show:{type:Boolean,required:!0},showCheck:{type:Boolean},orderId:{type:Number,required:!0},from:{type:String,required:!0},redirect:{type:String},orderAmount:{type:Number},safeArea:{type:Boolean,required:!0}},emits:["update:showCheck","update:show","close","success","fail"],setup(i,{emit:n}){const l=i;e.useRouter();const p=e.ref(),c=e.ref(o.PageStatusEnum.LOADING),d=e.ref({lists:[]}),m=e.computed({get:()=>l.showCheck,set(e){n("update:showCheck",e)}}),y=e.computed({get:()=>l.show,set(e){n("update:show",e)}}),v=()=>{y.value=!1,n("close")},j=s.useUserStore(),{isLock:h,lockFn:f}=t.useLockFn((async()=>{try{const t=await(async()=>{if(0==j.userInfo.is_auth&&[o.ClientEnum.OA_WEIXIN,o.ClientEnum.MP_WEIXIN].includes(a.client)&&p.value==r.PayWayEnum.WECHAT)switch(a.client){case o.ClientEnum.OA_WEIXIN:return wechatOa.getUrl(UrlScene.BASE,"snsapi_base",{id:l.orderId,from:l.from}),Promise.reject();case o.ClientEnum.MP_WEIXIN:return(await e.index.login()).code}})(),s=await(async t=>{try{e.index.showLoading({title:"正在支付中"});const o=await u.prepay({device:a.getClientString(),order_id:l.orderId,from:l.from,pay_way:p.value,redirect:l.redirect,code:t});return await r.pay.payment(o.pay_way,(null==o?void 0:o.config)||(null==o?void 0:o.payurl)||(null==o?void 0:o.qrcode))}catch(o){return Promise.reject(o)}})(t);q(s),e.index.hideLoading()}catch(t){e.index.hideLoading(),console.log(t)}})),q=e=>{switch(e){case o.PayStatusEnum.SUCCESS:n("success");break;case o.PayStatusEnum.FAIL:n("fail")}},w=()=>{q(o.PayStatusEnum.SUCCESS)},g=()=>{y.value=!0,q(o.PayStatusEnum.FAIL)};return e.watch((()=>l.show),(async e=>{if(e){if(!l.orderId)return void(c.value=o.PageStatusEnum.ERROR);await(async()=>{c.value=o.PageStatusEnum.LOADING;try{d.value=await u.getPayWay({order_id:l.orderId,from:l.from}),c.value=o.PageStatusEnum.NORMAL;const e=d.value.lists.find((e=>e.is_default))||d.value.lists[0];p.value=null==e?void 0:e.pay_way}catch(e){c.value=o.PageStatusEnum.ERROR}})()}}),{immediate:!0}),e.onMounted((async()=>{})),(r,u)=>e.e({a:e.p({text:"订单信息错误，无法查询到订单信息",mode:"order"}),b:e.f(d.value.lists,((r,u,t)=>({a:"d43ad9bc-4-"+t+",d43ad9bc-3",b:e.p({size:48,name:r.icon}),c:e.t(r.name),d:e.t(r.extra),e:"d43ad9bc-5-"+t+",d43ad9bc-3",f:e.p({name:r.pay_way}),g:u,h:e.o((e=>{return u=r.pay_way,void(p.value=u);var u}),u)}))),c:e.o((e=>p.value=e)),d:e.p({"active-color":r.$theme.primaryColor,modelValue:p.value}),e:i.orderAmount},i.orderAmount?{f:e.p({content:i.orderAmount,mainSize:"34rpx",minorSize:"34rpx",fontWeight:"500",color:"var(--color-btn-text)"})}:{},{g:e.o(e.unref(f)),h:e.p({shape:"circle",type:"primary",loading:e.unref(h)}),i:e.p({status:c.value,fixed:!1}),j:e.o(v),k:e.o((r=>e.isRef(y)?y.value=r:null)),l:e.p({mode:"bottom","safe-area-inset-bottom":i.safeArea,"mask-close-able":!1,"border-radius":"14",closeable:!0,"z-index":899,modelValue:e.unref(y)}),m:e.o(w),n:e.o(g),o:e.o((r=>e.isRef(m)?m.value=r:null)),p:e.p({from:i.from,"order-id":i.orderId,show:e.unref(m)})})}});wx.createComponent(n);
