"use strict";const e=require("../../common/vendor.js"),t=require("../../api/chat.js"),o=require("../../hooks/useLockFn.js"),a=require("../../stores/user.js"),r=require("../../pages/index/components/useSessionList.js"),s=require("../../stores/app.js"),u=require("../../enums/requestEnums.js"),n=require("../../hooks/useAudioPlay.js"),i=require("../../enums/constantEnums.js"),l=require("../../utils/validate.js"),c=require("../../hooks/useRecorder.js"),d=require("../../hooks/useAudio.js"),p=require("../../utils/device/vibrate.js"),v=require("../../config/index.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../utils/request/cancel.js"),require("../../router/index.js"),require("../../utils/cache.js"),require("../../api/user.js"),require("../../mixins/share.js"),require("../../api/task.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../utils/auth.js"),require("../../api/app.js"),require("../../lib/fft.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("network-switch")+e.resolveComponent("u-input")+e.resolveComponent("u-button")+e.resolveComponent("z-paging")+e.resolveComponent("guided-popup")+e.resolveComponent("recorder")+e.resolveComponent("dialog-poster")+e.resolveComponent("dragon-button"))()}Math||((()=>"../chat-record-item/chat-record-item.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../network-switch/network-switch.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../guided-popup/guided-popup.js")+(()=>"../recorder/recorder.js")+h+(()=>"../dialog-poster/dialog-poster.js")+(()=>"../dragon-button/dragon-button.js"))();const h=()=>"./components/online-voice.js",m=e.defineComponent({options:{virtualHost:!0,styleIsolation:"shared"},__name:"chat-scroll-view",props:{type:null,otherId:null,tips:{default:""},bottom:{default:"0"},placeholder:{default:"请输入内容"},currentModel:{default:""},safeAreaInsetBottom:{type:Boolean,default:!1},showAdd:{type:Boolean,default:!1},avatar:null},emits:["update:modelValue","reader"],setup(h,{expose:m,emit:f}){const g=h;let y=`${v.config.baseUrl}resource/image/api/default/bubble.gif`;const w=s.useAppStore(),j=e.useRouter(),q=a.useUserStore();e.shallowRef();const x=e.shallowRef(),k=e.ref(!1),b=e.ref(!1),T=e.ref(!1),_=e.ref(!1),{sessionActive:C,sessionAdd:I,currentSession:R,sessionEdit:z}=r.useSessionList(),A=e.ref([]),L=e.ref(""),$=e.ref(""),{authorize:B}=c.useRecorder({}),{pauseAll:V}=d.useAudio(),M=()=>{if(!q.isLogin)return se()},E=e.shallowRef(),S=async(e,o)=>{var a,r;try{const{lists:r=[],count:s}=await t.getChatRecord({type:g.type,other_id:1!==g.type?g.otherId:void 0,category_id:1===g.type?g.otherId:void 0,page_size:o/2,page_no:e});null==(a=E.value)||a.complete(r.reverse()),0===s?setTimeout((()=>{var e;null==(e=E.value)||e.scrollToTop(!1)}),200):1===o&&setTimeout((()=>{X()}),100)}catch(s){null==(r=E.value)||r.complete(!1)}},F=e.ref(!1),P=e=>{e.height>0?F.value=!0:F.value=!1},D=()=>{F.value=!1},U=async()=>{await J.value.startRecord(),T.value=!0,p.vibrate(100)};e.watch((()=>g.otherId),(e=>{setTimeout((()=>{var t,o;e?null==(t=E.value)||t.reload():(null==(o=E.value)||o.complete([]),setTimeout((()=>{var e;null==(e=E.value)||e.scrollToTop(!1)}),100))}),10)}),{immediate:!0});const H=async()=>{b.value?b.value=!1:(await O(),V(),b.value=!0)},N=async()=>{await O(),V(),_.value=!0},O=async()=>{if(!q.isLogin)return se(),Promise.reject();try{await B()}catch(t){return e.index.$u.toast(t),Promise.reject()}},J=e.shallowRef(),K=()=>{var e;null==(e=J.value)||e.stopRecord()},Y=e.shallowRef(),G=async t=>{const o=A.value.filter((e=>e.id==t));2==o.length?Y.value.initPosterData({title:o[1].content,content:o[0].content}):e.index.$u.toast("上下文数据不对～")},{lockFn:Q}=o.useLockFn((async e=>{if(console.log(e),Z.value)return;const o=A.value[e],a=A.value.findLast((({id:e})=>e===o.id));a&&(await t.cleanChatRecord({type:g.type,id:o.id}),A.value.splice(e,2),re(a.content))})),{lockFn:W}=o.useLockFn((async()=>{var o;if(!q.isLogin)return se();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(te(),await t.cleanChatRecord({type:g.type,other_id:1!==g.type?g.otherId:void 0,category_id:1===g.type?g.otherId:void 0}),null==(o=E.value)||o.reload())})),X=async()=>{var e;null==(e=E.value)||e.scrollToBottom(!1)},Z=e.ref(!1);let ee=null;const te=()=>{null==ee||ee.abort(),setTimeout((()=>{L.value=""}))},oe=e.ref({}),{pauseAll:ae}=n.useAudioPlay(),{lockFn:re}=o.useLockFn((async o=>{if(T.value=!1,!q.isLogin)return se();if(Z.value)return;if(q.userInfo.is_chat_limit&&l.isNewDay(!0,i.CHAT_LIMIT_KEY)){if((await e.index.showModal({title:"对话上限提示",content:"已超过会员对话上限次数，继续对话将会消耗账户的对话余额",confirmText:"继续",cancelText:"关闭"})).cancel)return}const a=o||L.value;if(!a)return e.index.$u.toast(g.placeholder);1==g.type&&(0===C.value&&await I(),"新的会话"===R.value&&await z(C.value,a)),E.value.addChatRecordData({type:1,content:a}),oe.value={type:2,loading:!0,content:[],id:Date.now()},E.value.addChatRecordData(oe.value),$.value=L.value,L.value="";try{Z.value=!0,await t.chatSendText({model:g.currentModel,question:a,type:g.type,other_id:g.otherId,network:k.value},{onstart(e){ee=e,ae(),L.value="",f("reader",e)},onmessage(t){t.trim().split("data:").forEach((async t=>{var o;if(""!==t)try{const a=JSON.parse(t),{event:r,data:s,code:u,index:n}=a;if("error"===r&&101===u)return L.value=$.value,void(null==(o=x.value)||o.open());if("error"===r)return e.index.$u.toast(s),void(L.value=$.value);if(s&&(oe.value.content[n]||(oe.value.content[n]=""),oe.value.content[n]+=s),"finish"===r)return void(oe.value.loading=!1)}catch(a){}}))},onclose(){Z.value=!1,setTimeout((()=>{var e;null==(e=E.value)||e.reload()}),600)}})}catch(r){console.log("发送消息失败=>",r),r.errMsg!==u.RequestErrMsgEnum.ABORT&&A.value.splice(0,2),L.value=$.value,Z.value=!1}})),se=()=>{j.navigateTo({path:"/pages/login/login"})};return e.onUnmounted((()=>{te()})),e.watch((()=>w.config),(()=>{(w.getIsVoiceTransfer||w.getIsVoiceChat)&&setTimeout((()=>{}),100)}),{immediate:!0}),e.watch(C,(async e=>{e&&te()})),m({scrollToBottom:X,setUserInput:(e="")=>{L.value=e},sendLock:re,rewrite:Q}),(t,o)=>e.e({a:e.f(A.value,((t,o,a)=>({a:e.o((t=>e.unref(Q)(o)),`${t.id} + ${o} + ''`),b:e.o((e=>A.value[e.index].is_collect=e.value),`${t.id} + ${o} + ''`),c:e.o(G,`${t.id} + ${o} + ''`),d:"45e1a1e6-1-"+a+",45e1a1e6-0",e:e.p({"record-id":t.id,type:1==t.type?"right":"left",content:t.content,loading:t.loading,audio:t.voice_file,index:o,time:2==t.type?t.create_time:"","is-collect":t.is_collect,avatar:h.avatar,showRewriteBtn:0===o,showPosterBtn:!0,showCopyBtn:!0}),f:`${t.id} + ${o} + ''`}))),b:A.value.length&&!Z.value},A.value.length&&!Z.value?{c:e.p({name:"play-circle",size:"36"}),d:e.o((t=>e.unref(re)("继续")))}:{},{e:Z.value},Z.value?{f:e.p({name:"pause-circle",size:"36"}),g:e.o((e=>te()))}:{},{h:1==h.type},1==h.type?{i:e.o((e=>k.value=e)),j:e.p({modelValue:k.value})}:{},{k:e.p({name:"trash",size:"28"}),l:e.o(((...t)=>e.unref(W)&&e.unref(W)(...t))),m:b.value},b.value?{n:e.o(U),o:e.o(K),p:e.o(K)}:{},{q:e.o(M),r:e.o(X),s:e.o((e=>L.value=e)),t:e.p({type:"textarea",placeholder:h.placeholder,maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!1,fixed:!1,"adjust-keyboard-to":"bottom",modelValue:L.value}),v:L.value},L.value?{w:e.o((t=>e.unref(re)())),x:e.p({type:"primary","custom-style":{width:"100rpx",height:"52rpx",margin:"0"},size:"mini",disabled:Z.value})}:e.unref(w).getIsVoiceTransfer?e.e({z:b.value},b.value?{A:e.p({name:"more-circle",size:52}),B:e.o(H)}:{C:e.p({name:"mic",size:52}),D:e.o(H)}):{},{y:e.unref(w).getIsVoiceTransfer,E:e.n(h.safeAreaInsetBottom?"safe-area-inset-bottom":""),F:e.sr(E,"45e1a1e6-0",{k:"pagingRef"}),G:e.o(S),H:e.o(P),I:e.o(D),J:e.o((e=>A.value=e)),K:e.p({"use-chat-record-mode":!0,auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"paging-style":{bottom:F.value?0:h.bottom},"default-page-size":20,modelValue:A.value}),L:e.sr(x,"45e1a1e6-10",{k:"guidedPopupRef"}),M:e.sr(J,"45e1a1e6-11",{k:"recorderRef"}),N:e.o(e.unref(re)),O:e.o((e=>T.value=e)),P:e.p({show:T.value}),Q:e.o((t=>{var o;return null==(o=e.unref(E))?void 0:o.reload()})),R:e.o((e=>_.value=e)),S:e.p({data:{model:h.currentModel,type:h.type,other_id:h.otherId,network:k.value},show:_.value}),T:e.sr(Y,"45e1a1e6-13",{k:"posterRef"}),U:1==h.type&&e.unref(w).getIsVoiceChat},1==h.type&&e.unref(w).getIsVoiceChat?{V:e.unref(y),W:e.p({"hover-class":"none","custom-style":{width:"100%",height:"58rpx",fontSize:"24rpx",background:"#28C840","box-shadow":"0 3px 10px #00000033"},type:"primary",shape:"circle"}),X:e.o(N),Y:e.p({size:184,yEdge:160})}:{})}}),f=e._export_sfc(m,[["__scopeId","data-v-45e1a1e6"]]);wx.createComponent(f);
