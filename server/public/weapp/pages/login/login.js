"use strict";const e=require("../../common/vendor.js"),n=require("../../stores/app.js"),o=require("../../hooks/useLockFn.js"),i=require("../../api/account.js"),t=require("../../stores/user.js"),u=require("../../utils/cache.js"),s=require("../../enums/constantEnums.js"),r=require("../../utils/util.js"),a=require("../../api/task.js");if(require("../../utils/client.js"),require("../../api/app.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../api/user.js"),require("../../mixins/share.js"),require("../../utils/auth.js"),require("../../stores/navigationBarTitle.js"),require("../../enums/appEnums.js"),!Array){(e.resolveComponent("u-divider")+e.resolveComponent("u-icon"))()}Math||(c+l+g+(()=>"../../uni_modules/vk-uview-ui/components/u-divider/u-divider.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+d+m)();const c=()=>"./components/weixin.js",l=()=>"./components/mobile.js",g=()=>"./components/mailbox.js",d=()=>"./components/update-user-info.js",m=()=>"./components/bind-mobile.js",p=e.defineComponent({__name:"login",setup(c){const l=n.useAppStore(),g=t.useUserStore(),d=e.useRouter(),m=e.useRoute(),p=e.ref(!1),f=e.ref(!1),v=e.ref(0),h=e.computed((()=>"1"==v.value)),_=e.computed((()=>"2"==v.value)),j=e.computed((()=>"3"==v.value)),q=e.computed((()=>l.getLoginConfig.login_way.includes("1"))),w=e.computed((()=>l.getLoginConfig.login_way.includes("2"))),y=e.computed((()=>l.getLoginConfig.login_way.includes("3"))),L=e.computed((()=>{var e;return(null==(e=l.getLoginConfig.login_way)?void 0:e.length)>1})),k=e.computed((()=>l.getWebsiteConfig)),C=e=>{v.value=e},x=e.ref({}),b=async()=>{!x.value.mobile&&l.getLoginConfig.coerce_mobile?f.value=!0:R()},R=async()=>{const{token:e}=x.value;g.login(e),g.getUser();const n=getCurrentPages();if(n.length>1){const e=n[n.length-2];await d.navigateBack();const{onLoad:o,options:i}=e;o&&o(i)}else if(u.cache.get(s.BACK_URL))try{d.redirectTo(u.cache.get(s.BACK_URL))}finally{d.switchTab(u.cache.get(s.BACK_URL))}else d.reLaunch("/pages/index/index");u.cache.remove(s.BACK_URL)},S=r.series((async()=>{const e=u.cache.get(s.SHARE_ID),n=u.cache.get(s.USER_SN);try{(e||n)&&(await a.bindInvite({share_id:e,user_sn:n},x.value.token),u.cache.remove(s.SHARE_ID),u.cache.remove(s.USER_SN))}catch(o){}}),(async()=>{if(x.value.is_new_user&&!p.value)try{await i.updateUser({avatar:x.value.avatar,nickname:x.value.nickname},{token:x.value.token})}catch(e){}else if(p.value)return Promise.reject()}),b),U=()=>{f.value=!1,R()},{lockFn:A,isLock:B}=o.useLockFn((async()=>{let n=null;n=await(async()=>{const{code:n}=await e.index.login({provider:"weixin"}),o=await i.mnpLogin({code:n});return o.is_new_user&&(p.value=!0),o})(),console.log(n),n&&(x.value=n,S())})),{lockFn:E}=o.useLockFn((async n=>{e.index.showLoading({title:"请稍后..."});try{const o=await i.login(n);x.value=o,await S(),e.index.hideLoading()}catch(o){e.index.hideLoading(),e.index.$u.toast(o)}})),F=async e=>{await i.updateUser(e,{token:x.value.token}),p.value=!1,b()};e.watch((()=>l.getLoginConfig),(e=>{v.value=e.default_login_way.toString()}),{immediate:!0});const I=()=>{const e=m.query;e.code&&e.state&&(delete e.code,delete e.state,d.redirectTo({path:m.path,query:e}))};return e.onLoad((async()=>{})),(n,o)=>e.e({a:n.$theme.navColor,b:n.$theme.navBgColor,c:n.$theme.pageStyle,d:e.unref(l).getWebsiteConfig.shop_logo,e:e.t(e.unref(l).getWebsiteConfig.shop_name),f:e.unref(h)},e.unref(h)?{g:e.o(e.unref(A)),h:e.p({loading:e.unref(B)})}:{},{i:e.unref(_)},e.unref(_)?{j:e.o(e.unref(E))}:{},{k:e.unref(j)},e.unref(j)?{l:e.o(e.unref(E))}:{},{m:e.unref(L)},e.unref(L)?e.e({n:e.unref(q)&&!e.unref(h)},e.unref(q)&&!e.unref(h)?{o:e.p({name:"/static/images/icon/icon_wx.png",size:80}),p:e.o((e=>C("1")))}:{},{q:e.unref(w)&&!e.unref(_)},e.unref(w)&&!e.unref(_)?{r:e.p({name:"/static/images/icon/icon_phone.png",size:80}),s:e.o((e=>C("2")))}:{},{t:e.unref(y)&&!e.unref(j)},e.unref(y)&&!e.unref(j)?{v:e.p({name:"/static/images/icon/icon_email.png",size:80}),w:e.o((e=>C("3")))}:{},{x:e.unref(h)?1:""}):{},{y:e.o(F),z:e.o((e=>p.value=e)),A:e.p({logo:e.unref(k).shop_logo,title:e.unref(k).shop_name,userInfo:x.value,show:p.value}),B:e.o(U),C:e.o(I),D:e.o((e=>f.value=e)),E:e.p({userInfo:x.value,show:f.value})})}});wx.createPage(p);
