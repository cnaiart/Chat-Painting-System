"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../api/chat.js"),o=require("../../../utils/date.js"),r=require("../../../hooks/useCopy.js"),i=require("../../../utils/util.js"),l=require("../../../hooks/useLockFn.js"),u=require("../../../utils/validate.js"),s=require("../../../enums/constantEnums.js"),n=require("../../../stores/user.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../config/index.js"),require("../../../stores/navigationBarTitle.js"),require("../../../api/user.js"),require("../../../mixins/share.js"),require("../../../api/task.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../utils/auth.js"),!Array){(e.resolveComponent("u-image")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("guided-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-image/u-image.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+p+v+c+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../components/guided-popup/guided-popup.js"))();const c=()=>"../../components/model-picker/model-picker.js",v=()=>"../../components/creation-history-item/creation-history-item.js",p=()=>"../../components/form-designer/form-designer.js",d=e.defineComponent({__name:"create",setup(c){const v=n.useUserStore(),p=e.ref(""),d=[{name:"WidgetTextarea",title:"多行文本",id:"question",props:{title:"内容描述",placeholder:"",rows:8,maxlength:400,autosize:!1,isRequired:!1}}],m=e.shallowRef(),{copy:h}=r.useCopy(),f=e.reactive({id:0,type:1,token:""}),y=e.shallowRef();e.shallowRef();const g=e.ref([]),q=e.ref({}),j=e.ref({}),w=e.ref([]),x=e.ref(!1),_=()=>{var e;if(q.value.question)return q.value.question;const t=(null==(e=j.value)?void 0:e.form[0])||{};return`${t.props.title}：${q.value[t.id]||""}`};let k=Date.now();const b=async()=>{var t;try{await(null==(t=y.value)?void 0:t.validate())}catch(r){return void e.index.$u.toast("必填项不能为空")}if(v.userInfo.is_chat_limit&&u.isNewDay(!0,s.CHAT_LIMIT_KEY)){if((await e.index.showModal({title:"对话上限提示",content:"已超过会员对话上限次数，继续对话将会消耗账户的对话余额",confirmText:"继续",cancelText:"关闭"})).cancel)return}x.value=!0,k=Date.now();try{await a.chatSendText({model:p.value,other_id:f.id,question:q.value,type:2},{onstart(e){g.value.length&&(g.value=[])},onmessage(t){t.trim().split("data:").forEach((t=>{var a;if(""!==t)try{const r=JSON.parse(t),{event:i,data:l,index:u,code:s}=r;"error"===i&&101===s?null==(a=m.value)||a.open():"error"===i&&e.index.$u.toast(l);let n=g.value.findIndex((e=>e.id===k));if("chat"===i&&(-1===n&&(g.value.push({create_time:o.timeFormat(new Date,"yyyy-mm-dd hh:MM:ss"),title:q.value.question?q.value.question:_(),reply:[],extra:e.cloneDeep(q.value),id:k}),n=g.value.length-1),l&&(g.value[n].reply[u]||(g.value[n].reply[u]=""),g.value[n].reply[u]+=l)),"finish"===i)return g.value[n].reply[u]+=l,void T()}catch(r){}}))},onclose(){setTimeout((()=>{x.value=!1}),500)}})}catch(r){x.value=!1}},C=()=>{var e;null==(e=j.value)||e.form.forEach((e=>{e.props.placeholder&&!e.props.defaultValue&&(q.value[e.id]=e.props.placeholder)}))},T=()=>{var t;null==(t=j.value)||t.form.forEach((t=>{t.props.defaultValue?q.value[t.id]=e.cloneDeep(t.props.defaultValue):q.value[t.id]=void 0}))},D=e.useRouter(),{lockFn:$}=l.useLockFn((async t=>{t&&(e.index.pageScrollTo({scrollTop:0,duration:0}),q.value=t,await e.nextTick$1(),b())})),R=()=>D.navigateTo({path:"/packages/pages/create_history/create_history",query:{id:f.id}});let I=null,E=0;const L=()=>{I&&clearInterval(I),I=setInterval((async()=>{var t;const a=await i.getRect(".current-history",!1,null==(t=e.getCurrentInstance())?void 0:t.proxy);a.height>E&&e.index.pageScrollTo({selector:"#bottom-line",duration:0}),E=a.height}),500)},S=()=>{I&&setTimeout((()=>{clearInterval(I)}),2e3)};return e.watch(x,(()=>{x.value?L():S()})),e.onUnmounted((()=>{S()})),e.onLoad((async t=>{f.id=Number(null==t?void 0:t.id),f.type=Number(null==t?void 0:t.type),await(async()=>{const t=await a.getCreationDetail({id:f.id});j.value=t,j.value.form||(j.value.form=d),w.value=e.cloneDeep(j.value.form),T()})(),e.index.$on("createRewrite",(e=>{$(e)}))})),e.onUnload((()=>{e.index.$off("createRewrite")})),(o,r)=>{var i,l,u,s;return e.e({a:o.$theme.navColor,b:o.$theme.navBgColor,c:o.$theme.pageStyle,d:j.value.name},j.value.name?e.e({e:e.p({src:j.value.image,width:"84",height:"84"}),f:e.t(j.value.name),g:j.value.tips},j.value.tips?{h:e.t(j.value.tips)}:{},{i:0==(null==(i=j.value)?void 0:i.is_collect)},0==(null==(l=j.value)?void 0:l.is_collect)?{j:e.p({name:"star",color:"#ccc",size:"32"})}:{},{k:1==(null==(u=j.value)?void 0:u.is_collect)},1==(null==(s=j.value)?void 0:s.is_collect)?{l:e.p({name:"star-fill",color:"#ffac25",size:"32"})}:{},{m:e.o((e=>(async e=>{await a.creationCollection({id:e}),j.value.is_collect=!j.value.is_collect})(j.value.id))),n:e.sr(y,"1750bee0-3",{k:"formDesignerRef"}),o:e.o((e=>q.value=e)),p:e.p({formLists:w.value,modelValue:q.value}),q:e.o(C),r:e.o(R),s:e.f(g.value,((t,a,o)=>({a:e.f(t.reply,((a,r,i)=>({a:e.o(e.unref(h),r),b:e.o((a=>e.unref($)(t.extra)),r),c:"1750bee0-4-"+o+"-"+i,d:e.p({title:t.title,time:t.create_time,content:a,showDelete:!1,"show-rewrite":!x.value}),e:r}))),b:t.id}))),t:!g.value.length},g.value.length?{}:{v:t._imports_0$3},{w:e.o((e=>p.value=e)),x:e.p({modelValue:p.value}),y:e.p({name:"trash"}),z:e.o(T),A:e.p({hairLine:!1,"custom-style":{width:"100%",border:"none",background:"#f5f5f5"}}),B:e.o(b),C:e.p({type:"primary",loading:x.value,"custom-style":{width:"100%"}}),D:e.sr(m,"1750bee0-9",{k:"guidedPopupRef"})}):{})}}});wx.createPage(d);
