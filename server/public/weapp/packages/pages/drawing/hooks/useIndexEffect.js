"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../api/drawing.js"),t=require("../../../../stores/user.js"),n=require("../../../../hooks/usePolling.js");exports.useIndexEffect=()=>{const i=t.useUserStore(),o=e.ref(0),r=e.ref(0),l=e.reactive({prompt:"",action:"generate",image_base:"",other:"",image_id:"",model:"",scale:"1:1",no_content:"",version:"",style:"default",engine:"",quality:"standard"}),s=e.ref(!1),u=e.ref([]),d=e.ref(3),c=[{name:"全部",value:-1},{name:"绘画完成",value:3},{name:"进行中",value:1},{name:"绘画失败",value:2}],g=e.shallowRef(null),v=e.ref([]),p=async t=>{try{(await e.index.showModal({title:"温馨提示",content:"是否确认删除当前绘画?",confirmColor:"#FFC94D"})).confirm&&(await a.drawingDelete({ids:t}),x(),m())}catch(n){console.log("删除失败绘画记录",n)}},m=async()=>{var e;null==(e=null==g?void 0:g.value)||e.reload()},w=async e=>{x(),g.value=e.reload,v.value=e.lists,u.value=e.lists.filter((e=>(1===e.status||0==e.status)&&e.loading)).map((e=>e.id)),console.log(!!u.value.length),setTimeout((()=>{u.value.length&&h()}),100)},f=()=>{const e=async()=>{await m(),await i.getUser()},{start:t,end:o,result:r}=n.usePolling((async()=>{try{const t=await a.drawingDetail({records_id:u.value});return t.filter((e=>3==e.status||2==e.status||!e.loading)).length&&(o(),e()),t}catch(t){o(),e(),console.log("获取详情失败=>",t)}}),{totalTime:48e4,time:5e3,count:96,callback:e});return{start:t,end:o,result:r}},{start:h,end:x}=f();e.onUnmounted((()=>{x()})),e.onUnload((()=>{o.value=0,x()}));const y=async t=>{if(!i.isLogin)return e.index.navigateTo({url:"/pages/login/login"});if(!t.drawing.prompt)return e.index.$u.toast("请输入绘画描述！");e.index.showLoading({title:"请求中"});try{x(),await a.drawing(t.drawing),d.value=-1,o.value=1,s.value=!0,v.value.unshift({status:1}),null==g||g.value.complete(v.value),t.isClear&&(l.prompt="",l.image_base="",l.no_content="",l.other=""),await m()}catch(n){if(v.value.splice(0,1),null==g||g.value.complete(v.value),"余额不足"===n){return void((await e.index.showModal({title:"绘画余额不足",content:"绘画余额不足，请前往充值",confirmText:"前往充值"})).confirm&&(i.isLogin?e.index.navigateTo({url:"/packages/pages/recharge/recharge"}):e.index.navigateTo({url:"/pages/login/login"})))}console.log("绘制失败=>",n),await m()}finally{e.index.hideLoading(),s.value=!1}};return e.provide("drawForm",l),e.provide("pageIndex",o),e.provide("consumptionCount",r),e.provide("isReceiving",s),e.provide("taskIndex",d),e.provide("taskLists",c),e.provide("deleteDrawing",p),e.provide("setTaskRecordFunc",w),e.provide("drawingHandler",y),{pageIndex:o,isReceiving:s,taskIndex:d,taskLists:c,deleteDrawing:p,setTaskRecordFunc:w,useDetails:f,drawingHandler:y}};
