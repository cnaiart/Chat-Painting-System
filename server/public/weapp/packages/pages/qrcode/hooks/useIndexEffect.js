"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../api/qrcode.js"),r=require("../../../../stores/user.js"),t=require("../../../../hooks/usePolling.js"),o=require("../enums/qrcodeEnums.js");exports.useIndexEffect=()=>{const n=r.useUserStore(),i=e.ref(0),s=e.ref(0),l=e.reactive({v:"3",iw:.45,seed:"",shape:"random",ar:"1:1"}),u=e.reactive({model:"mewx",type:1,qr_content:"",qr_image:"",prompt:"",prompt_params:"",model_id:"",template_id:"",way:1,aspect_ratio:"1:1",pixel_style:"square",marker_shape:"square"}),d=e.ref(!1),c=e.ref([]),m=e.ref(3),p=e.shallowRef(null),v=e.ref([]),g=async r=>{try{(await e.index.showModal({title:"温馨提示",content:"是否确认删除当前记录?",confirmColor:"#FFC94D"})).confirm&&(await a.qrcodeDelete({ids:r}),await f())}catch(t){console.log("删除失败记录",t)}},f=async()=>{var e;null==(e=null==p?void 0:p.value)||e.reload()},w=async e=>{h(),p.value=e.reload,v.value=e.lists,c.value=e.lists.filter((e=>1===e.status&&e.loading)).map((e=>e.id)),setTimeout((()=>{c.value.length&&x()}),100)},q=()=>{const e=async()=>{await f(),await n.getUser()},{start:r,end:o,result:i}=t.usePolling((async()=>{try{const r=await a.qrcodeDetail({records_id:c.value});return r.filter((e=>3==e.status||2==e.status||!e.loading)).length&&(o(),e()),r}catch(r){o(),e(),console.log("获取详情失败=>",r)}}),{totalTime:48e4,time:5e3,count:96,callback:e});return{start:r,end:o,result:i}},{start:x,end:h}=q();e.onUnmounted((()=>{h()})),e.onUnload((()=>{h()}));const y=async r=>{if(!n.isLogin)return e.index.navigateTo({url:"/pages/login/login"});if(2==r.params.type&&!r.params.qr_image)return e.index.$u.toast("请上传二维码！");if(1==r.params.type&&!r.params.qr_content)return e.index.$u.toast("请输入二维码内容！");if((1==r.params.way||o.QrcodeModeEnum.ZHISHUYUN===r.params.model)&&!r.params.prompt)return e.index.$u.toast("请输入生成方式！");e.index.showLoading({title:"请求中"});try{h(),await a.qrcodeImagine(r.params),m.value=-1,i.value=1,d.value=!0,v.value.unshift({status:1}),null==p||p.value.complete(v.value),r.isClear&&(u.prompt="",u.qr_image="",u.qr_content=""),await f()}catch(t){if(v.value.splice(0,1),null==p||p.value.complete(v.value),"余额不足"===t){return void((await e.index.showModal({title:"绘画余额不足",content:"绘画余额不足，请前往充值",confirmText:"前往充值"})).confirm&&(n.isLogin?e.index.navigateTo({url:"/packages/pages/recharge/recharge"}):e.index.navigateTo({url:"/pages/login/login"})))}console.log("绘制失败=>",t),await f()}finally{setTimeout((()=>{e.index.hideLoading()}),1e3),d.value=!1}};return e.provide("pageIndex",i),e.provide("consumptionCount",s),e.provide("promptParams",l),e.provide("qrcodeForm",u),e.provide("isReceiving",d),e.provide("taskIndex",m),e.provide("taskLists",[{name:"全部",value:-1},{name:"生成完成",value:3},{name:"进行中",value:1},{name:"生成失败",value:2}]),e.provide("setTaskRecordFunc",w),e.provide("deleteDrawing",g),e.provide("drawingHandler",y),{pageIndex:i,consumptionCount:s,qrcodeForm:u,deleteDrawing:g,setTaskRecordFunc:w,useDetails:q,drawingHandler:y}};
