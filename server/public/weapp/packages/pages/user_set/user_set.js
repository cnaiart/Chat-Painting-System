"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/user.js"),o=require("../../../api/app.js"),u=require("../../../enums/appEnums.js"),i=require("../../../hooks/useCopy.js"),l=require("../../../router/index.js"),t=require("../../../utils/client.js"),r=require("../../../stores/user.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../config/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../mixins/share.js"),require("../../../api/task.js"),require("../../../utils/util.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../utils/auth.js"),!Array){(e.resolveComponent("avatar-upload")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-form-item")+e.resolveComponent("u-popup")+e.resolveComponent("u-input")+e.resolveComponent("u-verification-code")+e.resolveComponent("u-action-sheet"))()}Math||((()=>"../../../components/avatar-upload/avatar-upload.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-form-item/u-form-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-verification-code/u-verification-code.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-action-sheet/u-action-sheet.js"))();const n=e.defineComponent({__name:"user_set",setup(n){const{copy:s}=i.useCopy(),v=r.useUserStore(),d=e.ref({}),c=e.ref(u.FieldType.NONE),p=e.ref(!1),m=e.ref(!1),h=e.ref(!1),g=e.ref(!1),f=e.ref([{text:"修改密码"},{text:"忘记密码"}]),w=e.ref(""),y=e.ref(""),b=e.ref(""),x=e.ref(""),j=e.ref(""),_=e.shallowRef(),q=async()=>{d.value=await a.getUserInfo()},C=e=>{j.value=e},k=async()=>{var a,i;if(!b.value)return e.index.$u.toast("请输入新的手机号码");(null==(a=_.value)?void 0:a.canGetCode)&&(await o.smsSend({scene:d.value.mobile?u.SMSEnum.CHANGE_MOBILE:u.SMSEnum.BIND_MOBILE,mobile:b.value}),e.index.$u.toast("发送成功"),null==(i=_.value)||i.start())},E=async a=>{e.index.showLoading({title:"正在上传中..."});try{const u=await o.uploadImage(a);$(u.uri),e.index.hideLoading()}catch(u){e.index.hideLoading(),e.index.$u.toast(u)}},$=e=>{c.value=u.FieldType.AVATAR,I(e)},B=async()=>{await a.userBindMobile({type:d.value.mobile?"change":"bind",mobile:b.value,code:x.value}),e.index.$u.toast("操作成功"),h.value=!1,q()},I=async o=>{await a.userEdit({field:c.value,value:o}),e.index.$u.toast("操作成功"),q()},M=()=>""==y.value?e.index.$u.toast("账号不能为空"):y.value.length>10?e.index.$u.toast("账号长度不得超过十位数"):(c.value=u.FieldType.USERNAME,I(y.value),void(m.value=!1)),N=async a=>(w.value=a.detail.value.nickname,""==w.value?e.index.$u.toast("昵称不能为空"):w.value.length>10?e.index.$u.toast("昵称长度不得超过十位数"):(c.value=u.FieldType.NICKNAME,await I(w.value),void(p.value=!1))),S=async o=>{const{encryptedData:u,iv:i,code:l}=o.detail,t={code:l,encrypted_data:u,iv:i};u&&(await a.userMnpMobile({...t}),e.index.$u.toast("操作成功"),q())},T=()=>{l.router.navigateTo("/packages/pages/cancelaccount/cancelaccount")},A=()=>{if(!d.value.has_password)return l.router.navigateTo("/packages/pages/change_password/change_password?type=set");g.value=!0},L=e=>{switch(e){case 0:l.router.navigateTo("/packages/pages/change_password/change_password");break;case 1:l.router.navigateTo("/packages/pages/forget_pwd/forget_pwd?type="+(d.value.mobile?2:3))}},V=()=>{v.logout(),l.router.reLaunch("/pages/index/index")},z=e.ref(!0),O=async()=>{if(!(null==d?void 0:d.value.has_auth)){e.index.showLoading({title:"请稍后..."});try{if(t.getClient()==u.ClientEnum.MP_WEIXIN){const{code:o}=await e.index.login({provider:"weixin"});await a.apiBindwx({code:o})}else t.getClient()==u.ClientEnum.OA_WEIXIN&&wechatOa.getUrl(UrlScene.BIND_WX)}catch(o){e.index.$u.toast(o)}finally{e.index.hideLoading()}}};return e.onShow((async()=>{q()})),e.onLoad((async e=>{})),(a,o)=>{var u,i,l,t,r,n,v,c,q,$,I;return e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:e.o(E),e:e.o((e=>d.value.avatar=e)),f:e.p({"file-key":"url",round:!0,modelValue:d.value.avatar}),g:e.t(null==(u=d.value)?void 0:u.nickname),h:e.p({name:"arrow-right",size:"22",color:"#666"}),i:e.o((e=>{var a;p.value=!0,w.value=null==(a=d.value)?void 0:a.nickname})),j:e.t(null==(i=d.value)?void 0:i.sn),k:e.p({name:"arrow-right",size:"22",color:"#666"}),l:e.o((a=>{var o;return e.unref(s)(null==(o=d.value)?void 0:o.sn)})),m:e.t(""==(null==(l=d.value)?void 0:l.mobile)?"未绑定手机号":null==(t=d.value)?void 0:t.mobile),n:e.t(""==(null==(r=d.value)?void 0:r.mobile)?"绑定手机号":"更换手机号"),o:e.o(S),p:e.p({"open-type":"getPhoneNumber",type:"primary",shape:"circle",size:"medium",plain:!0}),q:e.t(null==(n=d.value)?void 0:n.create_time),r:z.value},z.value?e.e({s:e.t(0==(null==(v=d.value)?void 0:v.has_auth)?"未绑定":"已绑定"),t:0==(null==(c=d.value)?void 0:c.has_auth)},0==(null==(q=d.value)?void 0:q.has_auth)?{v:e.p({name:"arrow-right",size:"22",color:"#666"})}:{},{w:e.o(O)}):{},{x:e.p({name:"arrow-right",color:"#666"}),y:e.o(A),z:null==($=d.value)?void 0:$.is_cancelled},(null==(I=d.value)?void 0:I.is_cancelled)?{A:e.p({name:"arrow-right",size:"22",color:"#666"}),B:e.o(T)}:{},{C:e.o(V),D:d.value.nickname,E:e.p({borderBottom:!0}),F:e.o(N),G:e.o((e=>p.value=e)),H:e.p({closeable:!0,mode:"center",maskCloseAble:!1,"border-radius":"20",modelValue:p.value}),I:e.o((e=>y.value=e)),J:e.p({placeholder:"请输入账号",border:!1,modelValue:y.value}),K:e.p({borderBottom:!0}),L:e.o(M),M:e.p({type:"primary",shape:"circle"}),N:e.o((e=>m.value=e)),O:e.p({closeable:!0,mode:"center","border-radius":"20",modelValue:m.value}),P:e.o((e=>b.value=e)),Q:e.p({placeholder:"请输入新的手机号码",border:!1,modelValue:b.value}),R:e.p({borderBottom:!0}),S:e.o((e=>x.value=e)),T:e.p({placeholder:"请输入验证码",border:!1,modelValue:x.value}),U:e.sr(_,"476a6c40-18,476a6c40-16",{k:"uCodeRef"}),V:e.o(C),W:e.p({seconds:60,"change-text":"x秒"}),X:e.t(j.value),Y:e.o(k),Z:e.p({borderBottom:!0}),aa:e.o(B),ab:e.p({type:"primary",shape:"circle"}),ac:e.o((e=>h.value=e)),ad:e.p({closeable:!0,mode:"center","border-radius":"20",modelValue:h.value}),ae:e.o(L),af:e.o((e=>g.value=e)),ag:e.p({list:f.value,"safe-area-inset-bottom":!0,modelValue:g.value})})}}});wx.createPage(n);
